<!doctype html>
<html>
<head>
<meta charset='UTF-8'><meta name='viewport' content='width=device-width initial-scale=1'>
<title>README_cn</title>
</head>
<body><h1 id='1panel-docker-镜像dood-方案'>1Panel Docker 镜像（DooD 方案）</h1>
<p align="center">
  <a href="/README.md"><img alt="English" src="https://img.shields.io/badge/English-d9d9d9"></a>
  <a href="/docs/README_cn.md"><img alt="中文(简体)" src="https://img.shields.io/badge/中文(简体)-d9d9d9"></a>
</p>
<p>本仓库用于构建并发布 1Panel 的 Docker 镜像，采用 DooD（Docker-out-of-Docker）设计，复用宿主机 Docker 引擎，使用 supervisord 管理 1Panel 进程，避免在容器内运行 systemd 或使用 --privileged。</p>
<ul>
<li>当前镜像最新版本：2.0.15</li>
<li>支持多版本：2.0.0 ~ 2.0.15（通过变量替换注入）</li>
<li>支持多系统：ubuntu、centos、alpine</li>
<li>支持多架构：amd64、arm64（buildx + QEMU）</li>
<li>镜像命名：caijiamx/1panel:dood-{version}-{os}-cn</li>
<li>构建方式：GitHub Actions 工作流 + 本地 Makefile</li>

</ul>
<p>提示：本方案适合可信、单租户环境，生产环境使用需严格控制访问并做好防护策略（建议WAF+网络防火墙）。</p>
<h2 id='目录'>目录</h2>
<ul>
<li><p><a href='#使用说明'>使用说明</a></p>
<ul>
<li><p><a href='#特性与设计'>特性与设计</a></p>
</li>
<li><p><a href='#支持系统与命名规范'>支持系统与命名规范</a></p>
</li>
<li><p><a href='#快速开始'>快速开始</a></p>
<ul>
<li><a href='#docker-run'>docker run</a></li>
<li><a href='#docker-compose'>docker-compose</a></li>

</ul>
</li>
<li><p><a href='#镜像拉取'>镜像拉取</a></p>
</li>
<li><p><a href='#目录结构'>目录结构</a></p>
</li>

</ul>
</li>
<li><p><a href='#实现方案'>实现方案</a></p>
<ul>
<li><a href='#systemctl-注释说明'>systemctl 注释说明</a></li>
<li><a href='#supervisord-说明'>supervisord 说明</a></li>
<li><a href='#dood说明'>DooD说明</a></li>
<li><a href='#为什么选择dood'>为什么选择DooD</a></li>
<li><a href='#dood-vs-dind-vs-sysbox对比'>DooD vs DinD vs Sysbox对比</a></li>

</ul>
</li>
<li><p><a href='#构建说明'>构建说明</a></p>
<ul>
<li><a href='#本地构建makefile'>本地构建（Makefile）</a></li>
<li><a href='#github-actions-构建'>GitHub Actions 构建</a></li>

</ul>
</li>
<li><p><a href='#升级说明'>升级说明</a></p>
<ul>
<li><a href='#版本升级步骤'>版本升级步骤</a></li>

</ul>
</li>
<li><p><a href='#常见问题'>常见问题</a></p>
<ul>
<li><a href='#服务功能限制'>服务&amp;功能限制</a></li>
<li><a href='#faq'>FAQ</a></li>

</ul>
</li>

</ul>
<h2 id='使用说明'>使用说明</h2>
<h3 id='特性与设计'>特性与设计</h3>
<ul>
<li><p>DooD：容器共享宿主机 Docker 引擎与缓存，构建更快、占用更小。</p>
</li>
<li><p>进程管理：容器内不运行 systemd，改用 supervisord 前台托管 1panel-core 与 1panel-agent。</p>
</li>
<li><p>版本变量注入：Dockerfile 中包含占位符，示例（ubuntu）：</p>
<pre><code>RUN bash /1panel/quick_start.sh v{%OnePanel_Version%}
</code></pre>
<p>构建时以 sed 将 {%OnePanel_Version%} 替换为具体版本（2.0.0~2.0.15）。</p>
</li>
<li><p>多架构：buildx + QEMU 生成 linux/amd64、linux/arm64 镜像；脚本会自动识别归档架构并下载对应包。</p>
</li>

</ul>
<h3 id='支持系统与命名规范'>支持系统与命名规范</h3>
<ul>
<li><p>系统：ubuntu、centos、alpine</p>
</li>
<li><p>版本：2.0.0 ~ 2.0.15</p>
</li>
<li><p>架构：amd64、arm64（自动匹配下载包）</p>
</li>
<li><p>标签规范：</p>
<ul>
<li>caijiamx/1panel:dood-{version}-{os}-cn</li>
<li>例：caijiamx/1panel:dood-2.0.15-ubuntu-cn</li>

</ul>
</li>

</ul>
<h3 id='快速开始'>快速开始</h3>
<h4 id='docker-run'>docker run</h4>
<p>容器构建自动生成用户名、密码、端口，可启动后在容器内调整。这里假设面板默认端口为 8888。运行命令示例：</p>
<pre><code class='language-shell' lang='shell'>docker run -d --name 1panel --restart unless-stopped \
  -p 8888:8888 \
  -v /var/run/docker.sock:/var/run/docker.sock \
  -v /var/lib/docker/volumes:/var/lib/docker/volumes \
  -v /1panel_app/data/:/opt/ \
  caijiamx/1panel:dood-2.0.15-ubuntu-cn
</code></pre>
<p>初始化（容器内）：</p>
<p><strong>重要的事情讲三遍！！！</strong></p>
<p><strong>首次部署务必修改用户名/密码/入口!</strong></p>
<p><strong>首次部署务必修改用户名/密码/入口!</strong></p>
<p><strong>首次部署务必修改用户名/密码/入口!</strong></p>
<pre><code class='language-shell' lang='shell'>docker exec -it 1panel bash
# 查看安全入口与当前配置
1panel user-info

# 修改端口/用户/密码
1panel update port
1panel update username
1panel update password
</code></pre>
<h4 id='docker-compose'>docker-compose</h4>
<p>仓库内提供示例 docker-compose.yml（DooD 必要挂载已包含）：</p>
<pre><code class='language-yaml' lang='yaml'>services:
  one_panel:
    image: caijiamx/1panel:dood-2.0.15-ubuntu-cn
    container_name: 1panel
    restart: unless-stopped
    ports:
      - &quot;8888:8888&quot;
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - /var/lib/docker/volumes:/var/lib/docker/volumes
      - /1panel_app/data/:/opt/
</code></pre>
<p>docker-compose.yml关键字段：</p>
<ul>
<li><p>image：镜像标签如 caijiamx/1panel:dood-2.0.15-ubuntu-cn</p>
</li>
<li><p>ports：对外端口映射，示例 8888:8888</p>
</li>
<li><p>volumes（DooD 必要挂载）：</p>
<ul>
<li>/var/run/docker.sock:/var/run/docker.sock</li>
<li>/var/lib/docker/volumes:/var/lib/docker/volumes</li>
<li>/panel_app/data/:/opt/  # 建议统一此路径，便于数据持久化</li>

</ul>
</li>
<li><p>healthcheck：简单进程检查（core/agent 是否存在）</p>
</li>
<li><p>extra_hosts：host-gateway 方便访问宿主机</p>
</li>
<li><p>networks：使用外部网络 one_panel（先创建网络）</p>
</li>

</ul>
<p>启动服务：</p>
<pre><code>docker network create one_panel
docker compose up -d
</code></pre>
<p>提示：</p>
<ul>
<li>不使用 --privileged、不挂载 /sys/fs/cgroup，不在容器内运行 systemd。</li>
<li>持久化 /opt/（默认安装到 /opt/1panel）。</li>

</ul>
<h3 id='镜像拉取'>镜像拉取</h3>
<pre><code class='language-shell' lang='shell'># Ubuntu
docker pull caijiamx/1panel:dood-2.0.15-ubuntu-cn
# CentOS
docker pull caijiamx/1panel:dood-2.0.15-centos-cn
# Alpine
docker pull caijiamx/1panel:dood-2.0.15-alpine-cn
</code></pre>
<p>将 {version} 替换为 2.0.0~2.0.15，{os} 替换为 ubuntu/centos/alpine。</p>
<h3 id='目录结构'>目录结构</h3>
<pre><code>alpine/   # Alpine Dockerfile 模板
centos/   # CentOS Dockerfile 模板
ubuntu/   # Ubuntu Dockerfile 模板
hack/     # 安装与 systemctl 注释脚本、supervisord 配置
hack_cn/     # 安装与 systemctl 注释脚本、supervisord 配置
.github/workflows/main.yml  # GitHub Action CI 多版本/多系统/多架构构建与推送
docker-compose.yml          # 容器运行配置
Makefile                    # 本地构建/推送/矩阵任务
</code></pre>
<h2 id='实现方案'>实现方案</h2>
<h3 id='systemctl-注释说明'>systemctl 注释说明</h3>
<ul>
<li>脚本：hack/fix_systemctl_start_cmd.sh</li>
<li>作用：在安装包解压后、执行 install.sh 前，注释掉 systemctl 相关步骤，避免容器依赖 systemd。</li>
<li>影响：面板内基于 systemctl 的检查/操作可能不可用或显示异常；进程管理交由 supervisord。</li>

</ul>
<p>&nbsp;</p>
<h4 id='涉及-systemctl-管理的服务'>涉及 systemctl 管理的服务</h4>
<p>20250909 由GitHub copilot 生成</p>
<p>根据 1Panel-dev/1Panel 仓库代码，涉及 systemctl 管理的服务主要有以下几类。如果 systemctl 不可用（如 WSL、部分容器、极简发行版等），这些服务的启动/停止/重启/状态查询都将受到影响，面板功能也会有部分不可用或异常。</p>
<figure class='table-figure'><table>
<thead>
<tr><th>服务名称</th><th>作用/描述</th><th>systemctl不可用时影响</th><th>代码依据/说明</th><th>说明</th></tr></thead>
<tbody><tr><td>1panel-core.service</td><td>1Panel 核心服务</td><td>无法启动/重启/查询状态，面板核心功能异常</td><td>core/app/service/setting.go, common.go、core/app/service/upgrade.go、RestartService (common.go), UpdateBindInfo/UpdatePort/UpdateSSL (setting.go), UpgradeService.Upgrade</td><td>面板配置、端口、SSL、主控服务、升级、回滚等重启</td></tr><tr><td>1panel-agent.service</td><td>1Panel Agent服务（节点服务）</td><td>无法启动/重启/查询状态，节点管理异常</td><td>agent/utils/common.go, common.go、core/app/service/upgrade.go、RestartService (common.go), UpgradeService.Upgrade</td><td>节点服务重启、升级后重启、节点异常恢复</td></tr><tr><td>docker.service, docker.socket</td><td>Docker 守护进程</td><td>容器管理、重启、停止等功能不可用</td><td>agent/app/service/docker.go</td><td>容器服务、应用容器管理、配置变更后重启</td></tr><tr><td>fail2ban.service</td><td>防暴力破解服务（Fail2Ban）</td><td>防护规则无法启停、重载或查询状态</td><td>agent/utils/toolbox/fail2ban.go</td><td>防护规则启停、重载、状态查询</td></tr><tr><td>clamav/clamd/freshclam</td><td>病毒扫描服务（ClamAV）</td><td>杀毒、病毒库更新相关功能不可用</td><td>agent/app/service/clam.go</td><td>杀毒服务启停、查杀操作、病毒库更新</td></tr><tr><td>ssh/sshd.service</td><td>SSH 服务</td><td>远程管理、SSH配置功能异常</td><td>agent/app/service/ssh.go</td><td>SSH服务启停、配置变更、安全加固</td></tr><tr><td>supervisor/supervisord</td><td>进程守护服务（Supervisor）</td><td>守护进程管理功能不可用</td><td>前端文案、脚本管理相关</td><td>守护进程启停、自动化任务、脚本运行</td></tr></tbody>
</table></figure>
<h4 id='代码说明'>代码说明</h4>
<ol start='' >
<li><p><strong>所有涉及 systemctl 的服务都依赖 systemd</strong></p>
<ul>
<li>代码中通过 systemctl 命令（如 restart, start, stop, status, is-active, is-enabled）管理服务。</li>
<li>如 systemctl 不可用，这些命令将执行失败，服务无法被面板控制。</li>

</ul>
</li>
<li><p><strong>Docker、SSH、Fail2Ban、ClamAV、Supervisor 这些常用服务都通过 systemctl 集成</strong></p>
<ul>
<li>面板会自动调用 systemctl 重启、检测状态，如果命令失败则功能不可用或报错。</li>
<li>部分服务有 snap 或其它方式检测</li>
<li>代码如 agent/utils/systemctl/systemctl.go 有 snap 服务的检测和操作，但依赖 snap 环境，非 systemctl 的通用替代。</li>

</ul>
</li>
<li><p><strong>面板自身服务（core/agent）也通过 systemctl 管理</strong></p>
<ul>
<li>面板自身无法自我重启/恢复，也无法远程管理节点。</li>

</ul>
</li>

</ol>
<hr />
<h4 id='systemctl-不可用时影响的面板功能'>systemctl 不可用时影响的面板功能</h4>
<ul>
<li>面板显示服务异常或未运行</li>
<li>无法通过面板启停 Docker、Agent、SSH、守护进程等</li>
<li>部分面板配置修改后无法自动生效（如端口、SSL等）</li>

</ul>
<p>详细参考：<a href='#服务功能限制'>服务&amp;功能限制</a></p>
<h4 id='主要接口函数举例'>主要接口/函数举例</h4>
<ul>
<li><code>/api/v1/setting/update_port</code> —— 端口修改，涉及 <code>RestartService</code> 调用 systemctl 重启 core 服务</li>
<li><code>/api/v1/setting/update_ssl</code> —— SSL 配置修改后，涉及 systemctl 重启 core 服务</li>
<li><code>/api/v1/upgrade/upgrade</code> —— 升级接口，涉及 <code>UpgradeService.Upgrade</code>，systemctl 重启 core/agent 服务</li>
<li><code>/api/v1/upgrade/rollback</code> —— 回滚接口，涉及 <code>UpgradeService.handleRollback</code>，systemctl 重启 core/agent 服务</li>
<li><code>/api/v1/docker/restart</code> —— 容器管理，调用 <code>OperateDocker</code>，systemctl 重启 docker 服务</li>
<li><code>/api/v1/agent/restart</code> —— 节点管理，重启 agent 服务</li>
<li><code>/api/v1/fail2ban/operate</code> —— 安全防护策略启停</li>
<li><code>/api/v1/clam/operate</code> —— 病毒查杀服务启停</li>
<li><code>/api/v1/ssh/operate</code> —— SSH 服务启停与配置</li>
<li><code>/api/v1/supervisor/operate</code> —— 守护进程服务启停</li>

</ul>
<p>&nbsp;</p>
<p>Upgrade 相关 systemctl 调用补全说明</p>
<ul>
<li><p>代码如 <code>core/app/service/upgrade.go</code> 的 <code>UpgradeService.Upgrade</code> 实现，升级成功后会调用：</p>
<ul>
<li><code>systemctl daemon-reload</code></li>
<li><code>systemctl restart 1panel-agent.service</code></li>
<li><code>systemctl restart 1panel-core.service</code></li>

</ul>
</li>
<li><p>回滚也会涉及 systemctl 重启相关服务。</p>
</li>
<li><p>其他分支或历史版本中，升级、回滚等函数如 <code>handleRollback</code>、<code>handleBackup</code> 也会调用 <code>systemctl daemon-reload &amp;&amp; systemctl restart 1panel.service</code>。</p>
</li>

</ul>
<h3 id='supervisord-说明'>supervisord 说明</h3>
<ul>
<li><p>配置：hack/supervisord.conf（nodaemon=true 前台运行）</p>
</li>
<li><p>托管：</p>
<ul>
<li>program:1panel-core -&gt; /usr/bin/1panel-core</li>
<li>program:1panel-agent -&gt; /usr/bin/1panel-agent</li>

</ul>
</li>
<li><p>常用命令：</p>
</li>

</ul>
<pre><code class='language-shell' lang='shell'>supervisorctl status
supervisorctl restart all
supervisorctl reload
</code></pre>
<h4 id='为什么不使用systemd'>为什么不使用systemd</h4>
<p>运行一个 systemd ，通常需要这样设置：</p>
<pre><code class='language-shell' lang='shell'>docker run -d -it \
  --name ubuntu2404-systemd \
  --privileged \
  --cgroupns=host \
  --tmpfs=/run \
  --tmpfs=/tmp \
  --volume=/sys/fs/cgroup:/sys/fs/cgroup:rw \
  trfore/docker-ubuntu2404-systemd:latest
</code></pre>
<p>核心风险点在于 <code>--privileged + --cgroupns=host + --volume /sys/fs/cgroup</code>：</p>
<ol start='' >
<li><p><strong>宿主机隔离被打破</strong></p>
<ul>
<li><code>--privileged</code> 让容器有所有 Linux capabilities（cap_sys_admin、cap_net_admin 等），等同 root。</li>
<li>可以直接操作宿主机设备文件、网络栈，甚至加载内核模块。</li>

</ul>
</li>
<li><p><strong>cgroup 控制泄露</strong></p>
<ul>
<li><code>--cgroupns=host</code> + 挂载 <code>/sys/fs/cgroup</code> → 容器能操作宿主机的 cgroups，修改 CPU/内存限制、杀死其他容器的进程。</li>

</ul>
</li>
<li><p><strong>宿主机提权/逃逸</strong></p>
<ul>
<li>特权容器几乎等于在宿主机上直接跑 root，隔离形同虚设。</li>
<li>如果攻击者拿到这个容器的 shell，就相当于拿到了宿主机 root。</li>

</ul>
</li>

</ol>
<h2 id='结论'>结论</h2>
<ol start='' >
<li>不要在生产环境使用 <code>--privileged</code> 参数。</li>
<li>现有阶段 docker 运行 systemd 不可行。</li>
<li>作为备用方案，可使用 supervisord 来服务管理。</li>

</ol>
<p>参考版本库：</p>
<ol start='' >
<li><a href='https://github.com/trfore/docker-ubuntu2404-systemd' target='_blank' class='url'>https://github.com/trfore/docker-ubuntu2404-systemd</a></li>
<li><a href='https://github.com/antmelekhin/docker-systemd' target='_blank' class='url'>https://github.com/antmelekhin/docker-systemd</a></li>
<li>建议只在开发环境使用。</li>

</ol>
<h3 id='dood说明'>DooD说明</h3>
<p>本指南提供一种“非官方”的 1Panel Docker 部署方案：</p>
<ol start='' >
<li>所谓的 DooD，就是 Docker Out of Docker。简单来讲，就是在一个 docker 容器内部调用外部的 Docker。
最简单的实现方式，共享 Host docker 的 sock 和 volumes。</li>
<li>使用 DooD（Docker‑out‑of‑Docker）复用宿主机 Docker 引擎，配合 supervisord 管理进程，避免在容器内运行 systemd 与 --privileged。</li>
<li>请在可信/单租户场景谨慎使用。需单独配置安全规则，如 WAF、防火墙。</li>

</ol>
<p>&nbsp;</p>
<p>容器内需复用宿主机 Docker 以安装/编排应用，需挂载：</p>
<ul>
<li>/var/run/docker.sock:/var/run/docker.sock</li>
<li>/var/lib/docker/volumes:/var/lib/docker/volumes</li>
<li>数据持久化目录（示例将 /1panel_app/data/ 映射到容器内 /opt/）</li>

</ul>
<p>参考docker-compose.yml：</p>
<pre><code class='language-yml' lang='yml'># 关键配置
volumes:
      # make docker out of docker work
      - /var/run/docker.sock:/var/run/docker.sock
      - /var/lib/docker/volumes:/var/lib/docker/volumes
      - /1panel_app/data/:/opt/
</code></pre>
<p>&nbsp;</p>
<h3 id='为什么选择dood'>为什么选择DooD</h3>
<h3 id='方案选型dood-vs-dind-vs-sysbox'>方案选型：DooD vs DinD vs Sysbox</h3>
<ul>
<li><p>DooD（本指南采用）</p>
<ul>
<li>优点：共享宿主机镜像缓存，构建快、占用少；实现简单</li>
<li>缺点：安全风险高（容器可控制宿主机 Docker），不适合多租户</li>
<li>适用：本机/可信环境、个人或单租户 CI</li>

</ul>
</li>
<li><p>DinD</p>
<ul>
<li>优点：容器内外引擎隔离</li>
<li>缺点：需要 --privileged，存在逃逸风险</li>
<li>适用：临时环境/非生产安全场景，谨慎使用</li>

</ul>
</li>
<li><p>Sysbox</p>
<ul>
<li>相对更安全的 DinD 替代，但对内核/发行版有要求，生态不如官方成熟</li>

</ul>
</li>

</ul>
<p>结论：</p>
<p>在当前条件下选用 DooD + supervisord，明确拒绝在生产环境用 --privileged 跑 systemd。</p>
<h3 id='dood-vs-dind-vs-sysbox对比'>DooD vs DinD vs Sysbox对比</h3>
<figure class='table-figure'><table>
<thead>
<tr><th>特性维度</th><th><strong>DooD (Docker-out-of-Docker)</strong></th><th><strong>DinD (Docker-in-Docker)</strong></th><th><strong>Sysbox</strong></th></tr></thead>
<tbody><tr><td><strong>基本原理</strong></td><td>容器内挂载宿主机 Docker socket，直接复用宿主机 Docker 引擎</td><td>在容器中运行独立的 Docker 引擎（DinD 镜像）</td><td>使用 Sysbox 作为底层 runtime，容器内可安全运行 Docker / K8s 等系统级 workload</td></tr><tr><td><strong>优点</strong></td><td>- 共享宿主机镜像缓存，构建速度快- 节省磁盘空间</td><td>- 简单易用，官方有现成 DinD 镜像- 容器内外引擎隔离，避免直接操作宿主机容器</td><td>- 无需 privileged 容器- 使用 Linux user namespace 提供强隔离- 支持系统级 workload（Docker/K8s）- 与 Docker/K8s 无缝集成，使用方式类似 <code>runc</code></td></tr><tr><td><strong>缺点</strong></td><td>- 安全风险极大：容器可直接控制宿主机 Docker，甚至删除宿主机所有容器- 不适合多租户环境- bind mount 限制，某些功能（如 volume 挂载）可能失效</td><td>- 需要 privileged 权限运行，容器内 root = 宿主机 root- root 拥有全部 Linux capabilities，存在逃逸风险- 可直接访问宿主机设备和 /proc、/sys，能修改内核状态</td><td>- 需要较新的 Linux 内核- 目前只支持部分 Linux 发行版- 仍在社区发展中，生态不如 Docker 官方成熟</td></tr><tr><td><strong>安全风险</strong></td><td>高：容器内用户几乎等于宿主机 root 权限</td><td>高：privileged 容器 = 宿主机 root + 全 capability，容易被利用</td><td>相对低：用户隔离（userns）、procfs/sysfs 虚拟化、syscall 拦截，避免直接 root 映射</td></tr><tr><td><strong>适用场景</strong></td><td>- 本地开发临时测试- 单人或可信环境</td><td>- CI/CD 流水线需要独立 Docker 环境- 简单快速的沙箱环境</td><td>- CI/CD 多租户 runner- 安全沙箱环境- 在容器中运行系统级 workload（如 Docker/K8s）</td></tr><tr><td><strong>推荐程度</strong></td><td>✅ 推荐（需控制访问权限）</td><td>⚠️ 谨慎使用（非生产安全场景）</td><td>❌ 不推荐（配置复杂）</td></tr></tbody>
</table></figure>
<p>参考链接：</p>
<ol start='' >
<li><a href='https://www.docker.com/resources/docker-in-docker-containerized-ci-workflows-dockercon-2023/'>Docker-in-Docker: Containerized CI Workflows</a></li>

</ol>
<h2 id='构建说明'>构建说明</h2>
<h3 id='本地构建makefile'>本地构建（Makefile）</h3>
<p>依赖：Docker Desktop（含 buildx），已登录 DockerHub（如需推送）。</p>
<p>列出命令：</p>
<pre><code class='language-shell' lang='shell'>make help
</code></pre>
<p>常用命令：</p>
<ul>
<li>初始化构建器（一次）：make builder</li>
<li>构建单个镜像（不推送）：make build OS=ubuntu VERSION=2.0.15 ONEPANEL_TYPE=cn</li>
<li>推送单个镜像：make push OS=centos VERSION=2.0.0 ONEPANEL_TYPE=cn</li>
<li>本机调试（加载到本地）：make load OS=ubuntu VERSION=2.0.15</li>
<li>多架构构建（不推送）：make buildx OS=centos VERSION=2.0.0</li>
<li>多架构构建并推送：make push OS=alpine VERSION=2.0.15</li>
<li>批量矩阵推送（3 OS × 2.0.0~2.0.15）：make matrix-push</li>

</ul>
<p>变量：</p>
<ul>
<li>OS=ubuntu|centos|alpine</li>
<li>VERSION=2.0.0~2.0.15（注入到 {%OnePanel_Version%}）</li>
<li>ONEPANEL_TYPE=pro|cn（注入到 {%OnePanel_Type%}）</li>
<li>PLATFORMS=linux/amd64,linux/arm64（可改为单架构）</li>
<li>IMAGE_REPO=caijiamx/1panel，IMAGE_TAG_PREFIX=dood</li>

</ul>
<p>构建示例</p>
<pre><code class='language-shell' lang='shell'># 调试单个命令
make -n build OS=ubuntu VERSION=2.0.15 ONEPANEL_TYPE=cn

# 构建单个镜像
make build OS=ubuntu VERSION=2.0.15 ONEPANEL_TYPE=cn
</code></pre>
<p>命名规范：caijiamx/1panel:dood-{version}-{os}-cn</p>
<h3 id='github-actions-构建'>GitHub Actions 构建</h3>
<p>工作流：.github/workflows/main.yml（“Build and Push 1Panel Images”）</p>
<ul>
<li><p>触发方式：推送分支 main/dev 或手动 workflow_dispatch</p>
</li>
<li><p>构建矩阵：OS=[ubuntu, centos, alpine]；VERSION=[2.0.0..2.0.15]</p>
</li>
<li><p>多架构：linux/amd64, linux/arm64（使用 setup-qemu + buildx）</p>
</li>
<li><p>版本替换：构建前用 sed 将 Dockerfile 中 v{%OnePanel_Version%} 替换为具体版本</p>
</li>
<li><p>推送目标：caijiamx/1panel:dood-{version}-{os}</p>
</li>
<li><p>凭据：需要在仓库 Secrets 配置</p>
<ul>
<li>DOCKERHUB_USERNAME</li>
<li>DOCKERHUB_TOKEN</li>

</ul>
</li>
<li><p>使用方式：Actions 页面选择 main 工作流，点 Run workflow，选择 os 与 version</p>
</li>

</ul>
<h2 id='升级说明'>升级说明</h2>
<p>从 v2.0.0 -&gt; v2.0.11升级为例，准备工作：</p>
<ol start='' >
<li>备份原始镜像，如 v2.0.0</li>
<li>备份挂载数据。</li>
<li>停止容器。</li>

</ol>
<h3 id='版本升级步骤'>版本升级步骤</h3>
<p>开始升级步骤：</p>
<ol start='' >
<li>构建/拉取新版本镜像（例如 2.0.11）</li>
<li>手动修改版本号</li>
<li>启动新服务。</li>

</ol>
<h3 id='手动修改版本号'>手动修改版本号</h3>
<p>官方安装会自动维护版本号；本镜像方案需手动同步版本号（示例使用 sqlite3）：</p>
<pre><code class='language-shell' lang='shell'>sudo apt-get update &amp;&amp; apt-get install -y sqlite3
cp /opt/1panel/db/core.db  /opt/1panel/db/core.db.bak
cp /opt/1panel/db/agent.db /opt/1panel/db/agent.db.bak
sqlite3 /opt/1panel/db/core.db &quot;UPDATE settings SET value=&#39;v2.0.11&#39; WHERE key=&#39;SystemVersion&#39;;&quot;
sqlite3 /opt/1panel/db/agent.db &quot;UPDATE settings SET value=&#39;v2.0.11&#39; WHERE key=&#39;SystemVersion&#39;;&quot;
</code></pre>
<p>更新镜像后重启容器（保留 /opt/ 数据卷）。</p>
<h2 id='常见问题'>常见问题</h2>
<h3 id='服务功能限制'>服务&amp;功能限制</h3>
<ol start='' >
<li>面板-&gt;右下角更新-&gt;“立即升级”不可用。官方升级逻辑依赖 systemctl 停启服务。</li>
<li><del>面板-&gt;容器功能不可用。服务判定 docker 存活依赖 systemctl status，后续会优化不再依赖 systemctl。</del></li>
<li>nginx_status 默认仅监听 127.0.0.1，需自行调整。参考：<a href='#openresty-当前状态报错'>OpenResty 当前状态报错</a></li>
<li>部分应用安装时挂载路径出现异常，需按实际路径修正。</li>
<li>1panel-core&amp;1panel-agent 运行用户为 root。指定用户 nobody 运行的话，服务 1panel-agent 会挂掉。</li>
<li>工具箱-&gt;进程守护、FTP、Fail2ban 不可用。</li>
<li>v2.0.11 版本改进了 docker 服务判定逻辑，面板-&gt;容器功能基本可用（完整功能未全面测试）。</li>
<li>v2.0.11 新增磁盘管理，不建议使用该功能。</li>
<li>v2.0.12 - v2.0.15 待验证兼容性。</li>

</ol>
<p>面板不可用功能表格如下：</p>
<figure class='table-figure'><table>
<thead>
<tr><th>功能</th><th>是否可用</th><th>备注</th></tr></thead>
<tbody><tr><td>面板-&gt;立即升级（右下角）</td><td>❌</td><td>&nbsp;</td></tr><tr><td>网站-&gt;网站-&gt;OpenResy设置-&gt;当前状态<br/>网站-&gt;运行环境-&gt;php-fpm容器状态检查</td><td>❌</td><td>&nbsp;</td></tr><tr><td>工具箱-&gt;进程守护、FTP、Fail2ban、磁盘管理</td><td>❌</td><td>功能未测试</td></tr><tr><td>高级功能</td><td>❌</td><td>功能未测试</td></tr></tbody>
</table></figure>
<h3 id='faq'>FAQ</h3>
<h4 id='安装应用报错-are-you-trying-to-mount-a-directory-onto-a-file'>安装应用报错 “Are you trying to mount a directory onto a file”</h4>
<ul>
<li>原因：主机路径与容器内路径不匹配（文件/目录）</li>
<li>处理：按应用需求修正宿主机路径与映射关系</li>

</ul>
<p>举例：</p>
<pre><code class='language-yml' lang='yml'># 容器内docker-compose.yml配置
- ${WEBSITE_DIR}:/www -&gt; /1panel_app/data/1panel/www:/www
# 容器内默认 1panel 项目目录:/opt/1panel
</code></pre>
<p>&nbsp;</p>
<p>常用变量</p>
<pre><code># 1panel 使用变量，用于文件 docker-compose.yml
${CONTAINER_NAME} # 自定义容器名

${IMAGE_NAME} # 自定义镜像名

${PANEL_APP_PORT_HTTP} # 自定义端口

${PANEL_WEBSITE_DIR} # 默认为 /opt/1panel/www

${WEBSITE_DIR} # 默认为 /opt/1panel/www
</code></pre>
<p>&nbsp;</p>
<h4 id='openresty-当前状态报错'>OpenResty 当前状态报错</h4>
<p>报错信息：</p>
<pre><code>服务内部错误: Get &quot;http://127.0.0.1/nginx_status&quot;: dial tcp 127.0.0.1:80: connect: connection refused
</code></pre>
<p>原因：健康检查 127.0.0.1 访问失败，容器内访问 127.0.0.1 会访问 1panel 监听80端口，而 openresty 是单独的容器，1panel -&gt; openresty 可以走 <code>http://openresty</code>。</p>
<p>处理：可为健康检查添加 <code>host：server_name 127.0.0.1 openresty;</code> 正确访问地址：<a href='http://openresty/nginx_status' target='_blank' class='url'>http://openresty/nginx_status</a>。</p>
<p>彻底解决问题，需要修改官方实现代码：</p>
<pre><code class='language-go' lang='go'># 文件路径：agent/app/service/nginx.go
func (n NginxService) GetStatus() (response.NginxStatus, error) {
  // bala
  url := &quot;http://127.0.0.1/nginx_status&quot;
	if httpPort != 80 {
		url = fmt.Sprintf(&quot;http://127.0.0.1:%v/nginx_status&quot;, httpPort)
	}
	useDoodMode := true
	if useDoodMode {
		localServerName := &quot;127.0.0.1&quot;
		openrestyContainerName := &quot;openresty&quot;
		url = strings.ReplaceAll(url, localServerName, openrestyContainerName)
	}
  // bala
}
</code></pre>
<p>&nbsp;</p>
<h4 id='反向代理配置'>反向代理配置</h4>
<p>WebSocket/升级头</p>
<pre><code class='language-nginx' lang='nginx'>proxy_http_version 1.1;
proxy_set_header Upgrade $http_upgrade;
proxy_set_header Connection &quot;upgrade&quot;;
proxy_set_header Host $host;  # 若需要固定后端 Host，请显式设置
</code></pre>
<p>&nbsp;</p>
<h4 id='安全入口与账户信息'>安全入口与账户信息</h4>
<ul>
<li><p>开启安全入口后，通过容器内命令查看：1pctl user-info</p>
</li>
<li><p>首次部署务必修改用户名/密码/入口</p>
</li>
<li><p>建议WAF+网络防火墙做好访问控制。</p>
<p>&nbsp;</p>
</li>

</ul>
<h4 id='cloudflare-常见端口'>Cloudflare 常见端口</h4>
<ul>
<li>HTTP：80, 8080, 8880, 2052, 2082, 2086, 2095</li>
<li>HTTPS：443, 2053, 2083, 2087, 2096, 8443</li>

</ul>
<p>&nbsp;</p>
<h4 id='资源与超时'>资源与超时</h4>
<p>CPU 限额过低可能导致接口超时（偶尔 5xx/超时），建议 1.0~1.5 core。</p>
<p>&nbsp;</p>
<h2 id='安全提示'>安全提示</h2>
<ul>
<li>DooD 允许容器控制宿主机 Docker，有一定安全风险。仅在可信、单租户环境使用。</li>
<li>建议配置网络防火墙允许访问的IP以及端口。</li>
<li>建议对面板做访问控制：域名限制、IP端口、机器隔离。</li>

</ul>
<h2 id='参考项目'>参考项目</h2>
<ol start='' >
<li><a href='https://github.com/okxlin/docker-1panel'>okxlin/docker-1panel</a>、<a href='https://github.com/tangger2000/1panel-dood'>tangger2000/1panel-dood</a>（项目已归档）</li>
<li><a href='https://github.com/purainity/docker-1panel-v2'>purainity/docker-1panel-v2</a>：<a href='https://github.com/dph5199278/docker-1panel'>dph5199278/docker-1panel</a>、<a href='https://github.com/Xeath/1panel-in-docker'>Xeath/1panel-in-docker</a></li>
<li></li>

</ol>
<h2 id='维护者'>维护者</h2>
<ul>
<li>GeekWho <a href='mailto:geekwho_eth@outlook.com' target='_blank' class='url'>geekwho_eth@outlook.com</a></li>

</ul>
<p>&nbsp;</p>
<p><a href='index.html'>返回首页</a></p>
</body>
</html>